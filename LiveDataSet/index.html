<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Data</title>
  <style>
    body {
      background: white;
      font-size: smaller;
      padding: 2em;
    }
    .choice {
      display: none;
    }
    .step-head {
      cursor: pointer;
    }
    .step {
      display: none;
    }
  </style>
  <script src="../Common/js/jquery.js"></script>
  <script src="../Common/js/iframe-phone.js" language="javascript"></script>

  <!-- google real time libraries. -->
<!--
  <link href="https://www.gstatic.com/realtime/quickstart-styles.css" rel="stylesheet" type="text/css"/>
-->

  <!-- Load the Realtime JavaScript library -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- Load the utility library -->
  <script src="https://www.gstatic.com/realtime/realtime-client-utils.js"></script>

  <script type="application/javascript">
    $(function () {

      // BEGIN --- handlers and methods for managing the U/I ---
      var dialogStep = null;
      function setDialogStep (step) {
        $('.step').hide();
        dialogStep = step;
        $('#' + step).slideDown();
      }
      setDialogStep('step-1');
      $('.step-head').on('click', function (ev) {
        setDialogStep($(this).next('.step')[0].id);
      });
      $('input[type=radio]').on('change', function (ev) {
        var change = $(this).data('choice');
        console.log('change: ' + change );
        $('.choice').hide();
        $('#' + change).slideDown();
      });
      // END --- handlers and methods for managing the U/I ---

      var codapInterface = Object.create({
        connection: null,
        connectionState: 'preinit', // ['preinit', 'init', 'active', 'inactive', 'closed']
        requestHandler: null,
        init: function () {
          this.connection = new iframePhone.IframePhoneRpcEndpoint(
            function (codapRequest, callback) {
              this.connectionState = 'active';
              if (this.requestHandler) {
                callback(this.requestHandler.handleCODAPRequest(codapRequest));
              } else {
                callback({success: true});
              }
            }.bind(this), "data-interactive", window.parent
          );
        },
        setRequestHandler: function (handler) {
          this.requestHandler = handler;
        },
        destroy: function () {},
        sendRequest: function (message, callback) {
          switch (this.connectionState) {
            case 'closed': // log the message and ignore
              console.warn('sendRequest on closed CODAP connection: ' + JSON.stringify(message));
              break;
            case 'preinit': // warn, but issue request.
              console.warn('sendRequest on not yet initialized CODAP connection: ' + JSON.stringify(message));
            default:
              if (this.connection) {
                this.connection.call(message, function (response) {
                  this.handleResponse(message, response, callback)
                }.bind(this));
              } else {
                console.error('sendRequest on non-existent CODAP connection');
              }
          }
        },
        handleResponse: function (request, response, callback) {
          if (response === undefined) {
            console.warn('handleResponse: CODAP request timed out');
          } else {
            this.connectionState = 'active';
          }
          if (callback) {
            callback(request, response);
          }
        }
      });

      var sharedValueManager = Object.create({
        codapInterface: null,
        collaborativeString: null,
        attributeName: 'x',
        init: function (codapInterface, collaborativeString) {
          this.codapInterface = codapInterface;
          this.collaborativeString = collaborativeString;
          codapInterface.setRequestHandler(this);
        },
        handleCODAPRequest: function (request) {
          console.log('handling request from CODAP: ' + JSON.stringify(request) );
          switch (request.resource) {
            case 'dataContextChangeNotice[single_value]':
              this.updateValue();
              break;
            default:
          }
          return {success: true};
        },
        updateValue: function () {
          if (codapInterface.connectionState === 'active') {
            this.codapInterface.sendRequest({
              action: 'get',
              resource: 'dataContext[single_value].collection[single_value].caseByIndex[0]'
            }, function (request, response) {
              if (response && response.success) {
                this.collaborativeString.setText(String(response.values.case.values.x));
              } else {
                DG.logWarn('case request failed');
              }
            }.bind(this));
          }
        }
      });
      codapInterface.init();

      // * * * * * *
      //ggl part
      var clientId = '208150541162-lss0ljo30b9jranj1jjg65fa90au5krh.apps.googleusercontent.com';

      if (!/^([0-9])$/.test(clientId[0])) {
        alert('Invalid Client ID - did you forget to insert your application Client ID?');
      }
      // Create a new instance of the realtime utility with your client ID.
      var realtimeUtils = new utils.RealtimeUtils({ clientId: clientId });

      authorize();

      function authorize() {
        // Attempt to authorize
        realtimeUtils.authorize(function(response){
          if(response.error){
            // Authorization failed because this is the first time the user has used your application,
            // show the authorize button to prompt them to authorize manually.
            var button = document.getElementById('auth_button');
            button.disabled=false;
            button.addEventListener('click', function () {
              realtimeUtils.authorize(function(response){
//                start();
                setDialogStep('step-2');
              }, true);
            });
          } else {
            setDialogStep('step-2');
//            start();
          }
        }, false);
      }

      function start() {
        // With auth taken care of, load a file, or create one if there
        // is not an id in the URL.
        var id = realtimeUtils.getParam('id');
        if (id) {
          // Load the document id from the URL
          realtimeUtils.load(id.replace('/', ''), onFileLoaded, onFileInitialize);
        } else {
          // Create a new document, add it to the URL
          realtimeUtils.createRealtimeFile('New Quickstart File', function(createResponse) {
            window.history.pushState(null, null, '?id=' + createResponse.id);
            console.log('Location: ' + window.location.href);
            $('.doc-url').html('<a href="' + +window.location.href+ + '">'+window.location.href+'</a>')
            realtimeUtils.load(createResponse.id, onFileLoaded, onFileInitialize);
          });
        }
        $('.doc-url').html('<a href="' + window.location.href + '">'+window.location.href+'</a>')
      }

      // The first time a file is opened, it must be initialized with the
      // document structure. This function will add a collaborative string
      // to our model at the root.
      function onFileInitialize(model) {
        var string = model.createString();
        string.setText($('.live-value').val());
        model.getRoot().set('demo_string', string);
      }

      // After a file has been initialized and loaded, we can access the
      // document. We will wire up the data model to the UI.
      function onFileLoaded(doc) {
        var collaborativeString = doc.getModel().getRoot().get('demo_string');
        wireTextBoxes(collaborativeString);
        sharedValueManager.init(codapInterface, collaborativeString);
        sharedValueManager.updateValue();
      }

      // Connects the text boxes to the collaborative string
      function wireTextBoxes(collaborativeString) {
        var textArea1 = document.getElementById('text_area_1');
        gapi.drive.realtime.databinding.bindString(collaborativeString, textArea1);
      }

      // end ggl part
      // * * * * * *
    });
  </script>
</head>
<body>
<h1>Live Data</h1>
<p>This CODAP data interactive demonstrates live sharing of CODAP data among
instances.
It uses the Google Real Time API.
</p>
<h3 class="step-head">Step 1: authorize</h3>
<div id="step-1" class="step">
  <p>First you must authorize this application.</p>
  <button id="auth_button">Authorize</button>
  <button id="unauth_button" disabled="disabled">Unauthorize</button>
</div>
<h3 class="step-head">Step 2: choose data set</h3>
<div id="step-2" class="step">
  <p>You can either collaborate on an existing data set or create a new one from
    the collaborative document.</p>
  <div>
    <label>
      <input type="radio" name="dataset-option" value="create" data-choice="attach-existing-data-set" id="existing-data_button"/>
      Collaborate on existing data
    </label>
    <label>
      <input type="radio" name="dataset-option" value="attach" data-choice="create-new-data-set" id="new-data-set_button">
      Make a new data set
    </label>
    <div class="choice" id="attach-existing-data-set">
      <label>Choose a data set: <select></select></label>
    </div>
    <div class="choice" id="create-new-data-set">
      <label>Data Set Name: <input type="text" id="new-data-set-name"/></label>
    </div>
  </div>
</div>
<h3 class="step-head">Step 3: create or link to a collaboration document</h3>
<div id="step-3" class="step set-up-collaboration">
  <p>You can either create a new collaborative document or attach to an existing
    collaborative document.</p>
  <div>
    <label>
      <input type="radio" name="doc-option" value="create" data-choice="create-dialog" id="create_button"/>
      Create collaborative document
    </label>
    <label>
      <input type="radio" name="doc-option" value="attach" data-choice="new-doc-url" id="attach_button"/>
      Attach to a collaborative document
    </label>
  </div>
  <div class="choice" id="create-dialog">
    <p>
      Collaborative document name: <input type="text" id="doc-name"/>
      <input type="submit" id="create" value="create"/>
    </p>
    <p id="new-doc-url">
      Share this url with collaborators: <span></span>
    </p>
  </div>
  <div class="choice" id="attach-dialog">
    Collaborative document URL: <input type="text" id="existing-doc-url"/>
  </div>
</div>
<h3 class="step-head">Step 4: connect</h3>
<div id="step-4" class="step">
  <div>id: <span class="doc-url"></span></div>
  <textarea id="text_area_1" class="live-value"></textarea>
</div>

</body>
</html>