<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Data</title>
  <style>
    body {
      background: white;
    }
  </style>
  <script src="../Common/js/jquery.js"></script>
  <script src="../Common/js/iframe-phone.js" language="javascript"></script>

  <!-- google real time libraries. -->
  <link href="https://www.gstatic.com/realtime/quickstart-styles.css" rel="stylesheet" type="text/css"/>

  <!-- Load the Realtime JavaScript library -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- Load the utility library -->
  <script src="https://www.gstatic.com/realtime/realtime-client-utils.js"></script>

  <script type="application/javascript">
    $(function () {
      var codapInterface = Object.create({
        connection: null,
        connectionState: 'preinit', // ['preinit', 'init', 'active', 'inactive', 'closed']
        requestHandler: null,
        init: function () {
          this.connection = new iframePhone.IframePhoneRpcEndpoint(
            function (codapRequest, callback) {
              this.connectionState = 'active';
              if (this.requestHandler) {
                callback(this.requestHandler.handleCODAPRequest(codapRequest));
              } else {
                callback({success: true});
              }
            }.bind(this), "data-interactive", window.parent
          );
        },
        setRequestHandler: function (handler) {
          this.requestHandler = handler;
        },
        destroy: function () {},
        sendRequest: function (message, callback) {
          switch (this.connectionState) {
            case 'closed': // log the message and ignore
              console.warn('sendRequest on closed CODAP connection: ' + JSON.stringify(message));
              break;
            case 'preinit': // warn, but issue request.
              console.warn('sendRequest on not yet initialized CODAP connection: ' + JSON.stringify(message));
            default:
              if (this.connection) {
                this.connection.call(message, function (response) {
                  this.handleResponse(message, response, callback)
                }.bind(this));
              } else {
                console.error('sendRequest on non-existent CODAP connection');
              }
          }
        },
        handleResponse: function (request, response, callback) {
          if (response === undefined) {
            console.warn('handleResponse: CODAP request timed out');
          } else {
            this.connectionState = 'active';
          }
          if (callback) {
            callback(request, response);
          }
        }
      });

//      var globalValueManager = Object.create({
//        codapInterface: null,
//        $view: null,
//        globalName: null,
//        globalValue: null,
//        getGlobalName: function () {
//          codapInterface.sendRequest({action: 'get', resource: 'globalList'},
//            function (request, response) {
//              var names = response && response.values;
//              if (names) {
//                this.globalName = names[0];
//                $('.global-name', this.$view).text(this.globalName)
//              }
//              this.getGlobalValue();
//            }.bind(this));
//
//        },
//        getGlobalValue: function () {
//          if (!this.globalName) {
//            return;
//          }
//          codapInterface.sendRequest({action: 'get', resource: 'global[' + this.globalName + ']'},
//              function (request, response) {
//                var value = response && response.values;
//                if (value) {
//                  this.globalValue = value;
//                  $('.global-value', this.$view).text(this.globalValue)
//                }
//              }.bind(this));
//        },
//        init: function (codapInterface, $view) {
//          this.codapInterface = codapInterface;
//          this.$view = $view;
//          codapInterface.init(this.codapMessageHandler);
//          this.getGlobalName();
//        }
//      });
//      globalValueManager.init(codapInterface, $('.global-display'));

      var sharedValueManager = Object.create({
        codapInterface: null,
        collaborativeString: null,
        attributeName: 'x',
        init: function (codapInterface, collaborativeString) {
          this.codapInterface = codapInterface;
          this.collaborativeString = collaborativeString;
          codapInterface.setRequestHandler(this);
        },
        handleCODAPRequest: function (request) {
          console.log('handling request from CODAP: ' + JSON.stringify(request) );
          switch (request.resource) {
            case 'dataContextChangeNotice[single_value]':
              this.updateValue();
              break;
            default:
          }
          return {success: true};
        },
        updateValue: function () {
          this.codapInterface.sendRequest({
            action: 'get',
            resource: 'dataContext[single_value].collection[single_value].caseByIndex[0]'
          }, function (request, response) {
            if (response.success) {
              this.collaborativeString.setText(String(response.values.case.values.x));
            } else {
              DG.logWarn('case request failed');
            }
          }.bind(this));
        }
      });
      codapInterface.init();

      // * * * * * *
      //ggl part
      var clientId = '208150541162-lss0ljo30b9jranj1jjg65fa90au5krh.apps.googleusercontent.com';

      if (!/^([0-9])$/.test(clientId[0])) {
        alert('Invalid Client ID - did you forget to insert your application Client ID?');
      }
      // Create a new instance of the realtime utility with your client ID.
      var realtimeUtils = new utils.RealtimeUtils({ clientId: clientId });

      authorize();

      function authorize() {
        // Attempt to authorize
        realtimeUtils.authorize(function(response){
          if(response.error){
            // Authorization failed because this is the first time the user has used your application,
            // show the authorize button to prompt them to authorize manually.
            var button = document.getElementById('auth_button');
            button.classList.add('visible');
            button.addEventListener('click', function () {
              realtimeUtils.authorize(function(response){
                start();
              }, true);
            });
          } else {
            start();
          }
        }, false);
      }

      function start() {
        // With auth taken care of, load a file, or create one if there
        // is not an id in the URL.
        var id = realtimeUtils.getParam('id');
        if (id) {
          // Load the document id from the URL
          realtimeUtils.load(id.replace('/', ''), onFileLoaded, onFileInitialize);
        } else {
          // Create a new document, add it to the URL
          realtimeUtils.createRealtimeFile('New Quickstart File', function(createResponse) {
            window.history.pushState(null, null, '?id=' + createResponse.id);
            console.log('Location: ' + window.location.href);
            $('.doc-url').append('<a href="' + window.location + '">click here</a>')
            realtimeUtils.load(createResponse.id, onFileLoaded, onFileInitialize);
          });
        }
      }

      // The first time a file is opened, it must be initialized with the
      // document structure. This function will add a collaborative string
      // to our model at the root.
      function onFileInitialize(model) {
        var string = model.createString();
        string.setText($('.live-value').val());
        model.getRoot().set('demo_string', string);
      }

      // After a file has been initialized and loaded, we can access the
      // document. We will wire up the data model to the UI.
      function onFileLoaded(doc) {
        var collaborativeString = doc.getModel().getRoot().get('demo_string');
        wireTextBoxes(collaborativeString);
        sharedValueManager.init(codapInterface, collaborativeString);
        sharedValueManager.updateValue();
      }

      // Connects the text boxes to the collaborative string
      function wireTextBoxes(collaborativeString) {
        var textArea1 = document.getElementById('text_area_1');
        var textArea2 = document.getElementById('text_area_2');
        gapi.drive.realtime.databinding.bindString(collaborativeString, textArea1);
        gapi.drive.realtime.databinding.bindString(collaborativeString, textArea2);
      }

      // end ggl part
      // * * * * * *


    });
  </script>
</head>
<body>
<h1>Live Data</h1>
<div>id: <span class="doc-url"></span></div>
<textarea id="text_area_1" class="live-value"></textarea>
<textarea id="text_area_2"></textarea>
<button id="auth_button">Authorize</button>

</body>
</html>