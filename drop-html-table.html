<!DOCTYPE html>
<html>
<head>
<title>Drag and drop experiments</title>
<style>
  body {
    background-color: lightslategray;
    height: 100%;
  }
  .drop-region {
    border: thin grey solid;
    border-radius: 5px;
    background-color: white;
    padding: 1em;
    text-align: center;
    width: 30em;
    margin-left: auto;
    margin-right: auto;
  }
  .output-region {
    background-color: lightgrey;
    border: thin darkgray solid;
  }
  .table-container {
    background-color: white;
    margin: .5em 0 0;
  }
  table td {
    font-size:small;
    border: thin solid gray;
  }
</style>
<script type="text/javascript" src="Common/js/jquery.js"></script>
<script type="text/javascript" src="Common/js/iframe-phone.js"></script>
<script type="text/javascript">
$(document).ready(function () {
  var connection;
  var connectionState = 'unstarted';
  var $dropRegion = $('.drop-region');
  var interactiveFrame = {
    name: 'TableDrop',
    dimensions: {x: 480, y: 640},
    preventDataContextReorg: false,
    preventBringToFront: false
  };


  function sendRequest(request, callback) {
    connection.call(request, callback);
  }

  function init() {
    function handleCODAPRequest(request, callback) {
    }

    connection = new iframePhone.IframePhoneRpcEndpoint(
        handleCODAPRequest, "data-interactive", window.parent);
    connectionState = 'initialized';
    sendRequest({
      "action": "update",
      "resource": "interactiveFrame",
      "values": interactiveFrame
    }, function (reply) { });
  }

  function handleRemove(ev) {
    var parentEl = ev.target.parentNode.parentNode;
    $(parentEl).remove();
  }

  function handleSend(ev) {
    function hasHeaderRow(firstRow) {
      return $('th', firstRow).length > 0;
    }

    function rowLength($row) {
      var $cols = $('th,td', $row);
      return $cols.length;
    }
    /**
     * Returns table stats object:
     *   numRows {number}
     *   maxCols {number}
     *   headerRows {[number]} Array of row indices of header rows
     *   rowLengthCounts {[number]} sparse array of counts of row lengths
     */
    function getTableStats($rows) {
      var stats = {
        numRows: 0,
        maxCols: 0,
        headerRows: [],
        rowLengthCounts: [],
        preponderantLength: 0
      }
      stats.numRows = $rows.length;
      $rows.each(function (ix, $row) {
        var len = rowLength($row);
        if (stats.rowLengthCounts[len]) {
          stats.rowLengthCounts[len]++;
        } else {
          stats.rowLengthCounts[len] = 1;
        }
        stats.maxCols = Math.max(stats.maxCols, len);
        if ($('th', $row).length === len) {
          stats.headerRows.push(ix);
        }
      });
      var maxCount = 0;
      stats.rowLengthCounts.forEach(function (count, ix) {
        if (maxCount < count) {
          maxCount = count;
          stats.preponderantLength = ix;
        }
      });
      console.log('stats: ' + JSON.stringify(stats));
      return stats;
    }

    function inferAttributeHeaderRow (stats, $rows) {
      var sel = stats.headerRows.find(function (rowIx) {
        return rowLength($rows[rowIx]) === stats.maxCols;
      });
      if ((sel === undefined) && stats.maxCols !== stats.preponderantLength) {
        sel = stats.headerRows.find(function (rowIx) {
          return rowLength($rows[rowIx]) === stats.preponderantLength;
        });
      }
      if (sel !== undefined) {
        return $rows[sel];
      }
    }

    function getAttributeDefinitions($headerRow, attrCount) {
      // we assume the first row is either all th or all td.
      var attrs = [], ix, attrName;
      var $cols = $('th,td', $headerRow);
      for (ix = 0; ix < attrCount; ix += 1) {
        if ($cols[ix]) {
          attrName = $($cols[ix]).text() || 'attr' + ix;
        } else {
          attrName = 'attr' + ix;
        }
        attrs.push( {
          name: attrName,
          editable: true
        });
      }
      return attrs;
    }

    // --- --- begin handleSend --- ---
    var parentEl = ev.target.parentNode.parentNode;
    var $srcTable = $('table', ev.target.parentNode.parentNode);
    var $rows = $('tr', $srcTable);
    var stats = getTableStats($rows);
    var $headerRow = inferAttributeHeaderRow(stats, $rows) || $rows[0];
    var headerNames;
    var contextName = $('.table-title', parentEl).val() || 'DropTarget';
    var attrs = getAttributeDefinitions($headerRow, stats.maxCols);
    sendRequest({
      action: 'create',
      resource: 'dataContext',
      values: {
        name: contextName,
        collections: [{
          name: contextName,
          attrs: attrs
        }]
      }
    }, function () {
      sendRequest({
        action: 'create',
        resource: 'component',
        values: {
          type: 'caseTable'
        }
      })
    });

    var cases = [];
    $rows.each(function (ix, row) {
      if (stats.headerRows.indexOf(ix) >= 0) return;
      var values = {};
      $('td,th', row).each(function(ix, cell) {
        values[attrs[ix].name] = $(cell).text();
      });
      cases.push ({values: values});
    });
    sendRequest({
      action: 'create',
      resource: 'case',
      values: cases
    });
//    $(parentEl).remove();
  }

  function formatTables(data, target) {

    function formatTable(ix, el) {
      function makeTableHeader(targetEl, ix) {
        var titleEl = $('<input>')
            .addClass('table-title')
            .val('Table_' + (ix + 1));
        var removeButton = $('<button>')
            .addClass('remove-button')
            .text('Remove');
        var sendButton = $('<button>')
            .addClass('send-button')
            .text('Transfer');
        var tableHeader =  $('<div>')
            .addClass('table-header')
            .append(titleEl)
            .append(removeButton)
            .append(sendButton);
        tableHeader.appendTo(targetEl);
        $(removeButton).on('click', handleRemove);
        $(sendButton).on('click', handleSend);
      }

      function formatRow(ix, el) {
        function formatCell(ix, el) {
          var txt = $(el).text();
          if (el.tagName === 'TD') {
            $('<td>').text(txt).appendTo(newRow);
          } else if (el.tagName === 'TH') {
            $('<th>').text(txt).appendTo(newRow);
          }
        } /* end formatCell */

        var newRow = $('<tr>');
        $('td,th', el).each(formatCell);
        newRow.appendTo(newTable);
      } /* end formatRow */

      var tableContainer = $('<div>').prop('id', 'table-' + ix).addClass('table-container').appendTo(target);
      var newTable = $('<table>');
      $('tr', el).each(formatRow);
      makeTableHeader(tableContainer, ix);
      $(newTable).appendTo(tableContainer);
    } /* end formatTable */

    var tables = $('table', $('<div>' + data + '</div>'));
    if (tables.length > 0) { target.html('<div>Found ' + tables.length + ' table(s)</div>'); }
    tables.each(formatTable);
  }

  $dropRegion.on('dragenter', function (ev) {
    var originalEvent = ev.originalEvent;
    originalEvent.preventDefault();
    return true;
  });
  $dropRegion.on('dragleave', function (ev) {
//    var originalEvent = ev.originalEvent;
//    originalEvent.preventDefault();
  });
  $dropRegion.on('dragover', function (ev) {
    var originalEvent = ev.originalEvent;
    originalEvent.preventDefault();
    originalEvent.dataTransfer.dropEffect = 'copy';
    return true;
  });

  $dropRegion.on('drop', function (ev) {
    var originalEvent = ev.originalEvent;
    originalEvent.preventDefault();
    var data = originalEvent.dataTransfer.getData('text/html');
    var data1 = originalEvent.dataTransfer.getData('text');
//    console.log('dropped text: ' + data1);
    formatTables(data, $('.output-region'));
  });

  init();
});
</script>
</head>
<body>
<h1>Drag and Drop HTML Tables</h1>
<p class="drop-region">Select the contents of a web page in another tab and drop it here.</p>
<div class="output-region" id="drag-to-region"></div>
<p>Drag HTML content to the above white region.
  Any tables in the page will be displayed.
  You can transfer to CODAP the ones you want.</p>
</body>
</html>
