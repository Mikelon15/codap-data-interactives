<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Data Interactive API Tester</title>
  <link rel="stylesheet" media="screen,projection" type="text/css" href="DataCard.css"/>
  <style>
    body {
      font-family: sans-serif;
      font-size: small;
    }
    label textarea {
      display:block;
    }
    label {
      font-size: smaller;
      font-family: sans-serif;
      font-weight: bold;
    }
    .di-req {
      background-color: rgba(0,255,0,0.1);
      text-overflow: ellipsis;
    }
    .di-resp {
      background-color: rgba(0,0,255,0.1);
      text-overflow: ellipsis;
    }
    .di-resp.fail { /* jshint ignore:line */
      color: red;
    }
    .di-comment {

    }
    .di-expect {
      background-color: rgba(128,128,128,0.1);
    }
    .di-req,.di-resp,.di-comment,.di-expect {
      padding: 2px 0 2px;
    }
    #receivedMessage, label textarea {
      height: 12em;
      width: 40em;
      overflow: scroll;
      border: thin solid darkslategrey;
      background-color: white;
      white-space: nowrap;
    }
  </style>
  <script src="../Common/js/iframe-phone.js" language="javascript"></script>
  <script src="../Common/js/jquery.js"></script>
  <script type="text/javascript">
    $(function () {
      var testCases = [
        {
          "comment": "Set interactive frame ......",
          "message": [{
            "action": "update",
            "resource": "interactiveFrame",
            "values": {
              "title": "DI-API Test",
              "version": "0.1",
              "preventBringToFront": false,
              "dimensions": {
                "width": 600,
                "height": 500
              }
            }
          },{
            "action": "get",
            "resource": "interactiveFrame"
          }],
          "expect": [{
            "success": true
          },{
            "success": true,
            "values": {
              "title": "DI-API Test",
              "version": "0.1",
              "dimensions": {
                "width": 600,
                "height": 500
              }
            }
          }]
        },
        {
          "comment": "Create a data Context .......",
          "message": {
            "action": "create",
            "resource": "dataContext",
            "values": {
              "name": "DataContext1",
              "title": "My Data Context",
              "description": "Displays individual items in a set of data, one item at a time."
            }
          },
          "expect": {
            "success": true
          }
        }, {
          "message": {
            "action": "get", "resource": "dataContextList"
          }, "expect": {
            "success": true,
            "values": [{
              "name": "DataContext1", "title": "My Data Context"
            }]
          }
        },
        {
          "message": {
            "action": "update",
            "resource": "dataContext[DataContext1]",
            "values": {
              "title": "Data, Data, Data"
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContextList"
          },
          "expect": {
            "success": true,
            "values": [{
              "title": "Data, Data, Data"
            }]
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1]"
          },
          "expect": {
            "success": true,
            "values": {
              "title": "Data, Data, Data"
            }
          }
        },

        {
          "comment": "Create a collection ........",
          "message": {
            "action": "create",
            "resource": "dataContext[DataContext1].collection",
            "values": {
              "name": "Disney_Characters",
              "title": "Poeple"
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collectionList"
          },
          "expect": {
            "success": true,
            "values": [{
              "name": "Disney_Characters",
              "title": "Poeple"
            }]
          }
        },
        {
          "message": {
            "action": "update",
            "resource": "dataContext[DataContext1].collection[Disney_Characters]",
            "values": {
              "title": "People"
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collection[Disney_Characters]"
          },
          "expect": {
            "success": true,
            "values": {
              "name": "Disney_Characters",
              "title": "People"
            }
          }
        },
        {
          "comment": "Create attributes ..........",
          "message": {
            "action": "create",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].attribute",
            "values": [
              {
                "name": "name",
                "type": "categorical"
              },
              {
                "name": "age",
                "type": "numeric"
              },
              {
                "name": "height (cm)",
                "type": "numeric"
              }
            ]
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].attribute[name]"
          },
          "expect": {
            "success": true,
            "values":{"title":"name"}
          }
        },
        {
          "message": {
            "action": "update",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].attribute[name]",
            "values": {
              "title": "Name"
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].attribute[name]"
          },
          "expect": {
            "success": true,
            "values":{"title":"Name"}
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].attribute[age]"
          },
          "expect": {
            "success": true,
            "values":{"type":"numeric"}
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].attributeList"
          },
          "expect": {
            "success": true,
            "values":[{name:'name'},{name:'age'},{name:'height'}]
          }
        },
        {
          "comment": "create some cases ......",
          "message": {
            "action": "create",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].case",
            "values": {
              "values": {
                "name": "Mickey",
                "age": 88,
                "height": 40
              }
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "create",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].case",
            "values": [
              {
                "values": {
                  "name": "Minnie",
                  "age": 88,
                  "height": 38
                }
              },
              {
                "values": {
                  "name": "Donald",
                  "age": 82,
                  "height": 51
                }
              }
            ]
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].caseCount"
          },
          "expect": {
            "success": true,
            "values": 3
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].caseByIndex[0]"
          },
          "expect": {
            "success": true,
            "values": {"case": {"values": {"name": "Mickey"}}}
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].collection[Disney_Characters].caseByIndex[1]"
          },
          "expect": {
            "success": true,
            "values": {"case": {"values": {"name": "Minnie"}}}
          }
        },
        {
          "message": {
            "action": "create",
            "resource": "component",
            "values": {
              "type": "calculator"
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "create",
            "resource": "component",
            "values": {
              "type": "map",
              "dimensions": {
                "width": 240,
                "height": 240
              }
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "create",
            "resource": "component",
            "values": {
              "type": "slider",
              "name": "ageSlider",
              "lowerBound": -0.5,
              "upperBound": 21.5,
              "animationDirection": 1,
              "animationMode": 1,
              "title": "ageSlider"
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "create",
            "resource": "component",
            "values": {
              "type": "text",
              "componentStorage": {
                "text": "T'was brillig and the slithy toves did gyre and gimble in the wabe."
              }
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "create",
            "resource": "component",
            "values": {
              "type": "graph",
              "name": "HeightAge",
              "dimensions": {
                "width": 240,
                "height": 240
              },
              "position": "top",
              "dataContext": "DataContext1",
              "xAttribute": "age",
              "yAttribute": "height"
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "create",
            "resource": "component",
            "values": {
              "type": "caseTable",
              "dimensions": {
                "width": 480,
                "height": 200
              },
              "dataContext": "DataContext1"
            }
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "create",
            "resource": "component",
            "values": {
              "type": "webView",
              "title": "Concord",
              "url": "http://www.concord.org"
            }
          },
          "expect": {
            "success": true
          }
        },
//        {
//          "message": {
//            "action": "get",
//            "resource": "componentList"
//          },
//          "expect": {
//            "success": true
//          }
//        },
        {
          "message": {
            "action": "create",
            "resource": "dataContext[DataContext1].selectionList",
            "values": [
              9
            ]
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].selectionList"
          },
          "expect": {
            "success": true,
            "values": [{
              "caseID": 9
            }]
          }
        },
        {
          "message": {
            "action": "update",
            "resource": "dataContext[DataContext1].selectionList",
            "values": [
              10
            ]
          },
          "expect": {
            "success": true
          }
        },
        {
          "message": {
            "action": "get",
            "resource": "dataContext[DataContext1].selectionList"
          },
          "expect": {
            "success": true,
            "values": [{
              "caseID": 9
            },{
              "caseID": 10
            }]
          }
        }
      ];

      var codapPhone = new iframePhone.IframePhoneRpcEndpoint(function () {
      }, "data-interactive", window.parent);
      var seq = 0;
      var successes = 0;

      function send() {
        try {
          var message = $('#message').val();
          if (!message) { return; }
          var parsedMessages = JSON.parse(message);

          if (!Array.isArray(parsedMessages)) {
            parsedMessages = [parsedMessages];
          }

          var compareObj = function(obj1, obj2) {
            var ret = {},rett;
            for(var i in obj1) {
              rett = {};
              if (typeof obj1[i] === 'object'){
                rett = compareObj (obj1[i], obj2[i]) ;
                if (!$.isEmptyObject(rett) ){
                  ret[i]= rett
                }
              }else{
                if(!obj2 || !obj2.hasOwnProperty(i) || obj1[i] !== obj2[i]) {
                  ret[i] = obj1[i];
                }
              }
            }
            return ret;
          };

          function logComment(id, comment) {
            if (comment) {
              $('<div>').prop('id', 'r' + id).addClass('di-comment').text('#' + id +
                      ' Comment: ' + comment)
                  .appendTo('#receivedMessage');
            }
          }

          function sendOneMessage(msgNum) {
            if (msgNum >= parsedMessages.length) { return; }
            var id = ++seq;
            var parsedMessage = parsedMessages[msgNum].message;
            var expected = parsedMessages[msgNum].expect;
            var comment = parsedMessages[msgNum].comment;
            console.log('Message: ' + JSON.stringify(parsedMessage));
            logComment(id, comment);
            $('<div>')
                .prop('id', 'r' + id)
                .addClass('di-req')
                .text('#' + id + ' Request: ' + JSON.stringify(parsedMessage))
                .appendTo('#receivedMessage');
            if (expected) {
              $('<div>')
                  .addClass('di-expect')
                  .text('#' + id + ' Expect: ' + JSON.stringify(expected))
                  .appendTo('#receivedMessage');
            }
            codapPhone.call(parsedMessage, function (result) {
              var failClass = '';
              var diff;
              if (result && expected) {
                diff = compareObj(expected, result);
                if ($.isEmptyObject(diff)) {
                  successes++;
                } else {
                  failClass = 'fail';
                }
              } else if (result && result.success) {
                successes++;
              } else {
                failClass = 'fail'
              }
              var respEl = $('<div>')
                  .addClass('di-resp').addClass(failClass)
                  .text('#' + id + ' Response: ' + JSON.stringify(result))
                  .appendTo('#receivedMessage');
//              $('#r' + id).append(respEl);
              $('#success').text(successes);
              console.log('Reply: ' + JSON.stringify(result));
              sendOneMessage(msgNum+1);
            });
            $('#sentMessages').text(seq);
          }
          sendOneMessage(0);
        } catch (e) {
          $('#receivedMessage').prepend($('<div>').text('' + (++seq) + ': ' + e));
        }
      }


      $('#message').text(JSON.stringify(testCases, null, '  '));

      $('#sendMessage').on('click', send);
    });
  </script>
</head>
<body>
<header>
  <h1>Data Interactive API Tester</h1>
</header>
<article>
  <p>Enter a Data Interactive request message as parse-able JSON, or an array of messages.</p>
  <label>Requests:<textarea id="message" rows="12" cols="80"></textarea></label>
  <div><button id="sendMessage">send</button></div>
  <div id="receivedMessage"></div>
  <div>Sent: <span id="sentMessages">0</span> Success: <span id="success">0</span></div>
</article>
</body>
</html>